{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/forms.css' %}">
    <title>{% if form.instance.pk %}Edit{% else %}Add{% endif %} Problem</title>
</head>

<body>
{% include "nav.html" %}

<script> window.MathJax = {tex: {inlineMath: [['\\(','\\)']],displayMath: [['$$','$$']]}, svg: { fontCache: 'global' }};</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>


<div class="form-container">
    <h2>{% if form.instance.pk %}Edit{% else %}Add New{% endif %} Problem</h2>

    <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form.as_p }}

        <h6 style="color:red"><strong>Input and Output File Uploading Instructions</strong></h6>
        <p>
            1. <strong>Create sample test cases</strong> and save them in separate files, naming them as
            <em>test_input_1.txt</em>, <em>test_input_2.txt</em>, ... and similarly
            <em>test_output_1.txt</em>, <em>test_output_2.txt</em>, ...
        </p>
        <p>
            2. <strong>Upload</strong> the <em>test_input</em> and <em>test_output</em> files in their respective fields.
        </p>


        <h4>Test Inputs</h4>
        <input type="file" name="test_inputs" multiple class="form-control mb-3">

        <h4>Test Outputs</h4>
        <input type="file" name="test_outputs" multiple class="form-control mb-3">


        <h4>Examples</h4>

        <div id="empty-example-form" style="display:none;">
            <div class="example-form mb-3 border p-2">
                <button class="btn btn-sm btn-danger remove-example" type="button">Remove</button>
                <div class="mb-2">
                    <label>Input:</label>
                    <textarea name="__prefix__-input" class="form-control" rows="5"></textarea>
                </div>
                <div class="mb-2">
                    <label>Output:</label>
                    <textarea name="__prefix__-output" class="form-control" rows="5"></textarea>
                </div>
                <div class="mb-2">
                    <label>Note:</label>
                    <textarea name="__prefix__-note" class="form-control" rows="6"></textarea>
                </div>
                <input type="hidden" name="__prefix__-id" />
                <input type="checkbox" name="__prefix__-DELETE" style="display:none;">
            </div>
        </div>

        <div id="example-forms">
            {{ formset.management_form }}
            {% for f in formset %}
            <div class="example-form mb-3 border p-2">
                <button class="btn btn-sm btn-danger remove-example" type="button">Remove</button>
                {{ f.id }}
                <div class="mb-2">{{ f.input.label_tag }} {{ f.input }}</div>
                <div class="mb-2">{{ f.output.label_tag }} {{ f.output }}</div>
                <div class="mb-2">{{ f.note.label_tag }} {{ f.note }}</div>
                {{ f.DELETE }}
            </div>
            {% endfor %}
        </div>

        <button class="btn btn-secondary mb-3" id="add-example" type="button">Add Example</button>
        <br>
        <button class="btn btn-success" type="submit">Save Problem</button>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'ckeditor/ckeditor/ckeditor.js' %}"></script>
<script src="{% static 'ckeditor/ckeditor-init.js' %}"></script>


<!--Needs to be inline to work-->
<script>
$(document).ready(function(){
    let formIdx = {{ formset.total_form_count }};

    $('#add-example').click(function(){
        // Clone the hidden template
        let newForm = $('#empty-example-form .example-form').clone();

        // Replace __prefix__ with current index
        newForm.html(newForm.html().replace(/__prefix__/g, formIdx));

        // Increment the total form counter
        formIdx++;
        $('#id_form-TOTAL_FORMS').val(formIdx);

        // Add to the page
        $('#example-forms').append(newForm);
    });

    // Remove example
    $('#example-forms').on('click', '.remove-example', function(){
        let container = $(this).closest('.example-form');

        // Mark as DELETE if it has a hidden DELETE field (existing form)
        let deleteInput = container.find('input[name$="-DELETE"]');
        if(deleteInput.length){
            deleteInput.prop('checked', true);
        }

        // Hide the form
        container.hide();
    });
});
</script>

</body>
</html>
