{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/problems/problem_detail.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>Problem Detail</title>
</head>
<body>

    {% include "nav.html" %}

    {% block content %}
    <div class="oj-layout container mt-4">
        <div class="problem-main">
            <h1>{{ problem.title }}</h1>
            <hr>

            <section class="problem-section">
                <h4>Statement</h4>
                <p>{{ problem.statement|safe }}</p>
            </section>

            <section class="problem-section">
                <h4>Input</h4>
                <p>{{ problem.input_specification|safe  }}</p>
            </section>

            <section class="problem-section">
                <h4>Output</h4>
                <p>{{ problem.output_specification|safe  }}</p>
            </section>

            {% if problem.examples %}
            <section class="problem-section">
                <h4>Examples</h4>
                {% for example in problem.examples.all %}
                <div class="example-block">
                    <div class="example-label">Input</div>
                    <pre><code>{{ example.input|safe }}</code></pre>
                    <button class="copy-btn btn btn-sm btn-primary">Copy Input</button>
                </div>

                <div class="example-block">
                    <div class="example-label">Output</div>
                    <pre><code>{{ example.output|safe }}</code></pre>
                    <button class="copy-btn btn btn-sm btn-primary">Copy Output</button>
                </div>

                {% if example.note %}
                <div class="example-note"><strong>Note:</strong> {{ example.note }}</div>
                {% endif %}
                {% endfor %}
            </section>
            {% endif %}

            {% if problem.created_by == request.user %}
            <div class="author-controls mt-4">
                <a href="{% url 'problem_crud' pk=problem.pk %}" class="btn btn-warning">Edit</a>
                <form action="{% url 'problem_delete' pk=problem.pk %}" method="post" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this problem?')">Delete</button>
                </form>
            </div>
            {% endif %}
        </div>

        <aside class="problem-sidebar">
            <div class="sidebar-card">
                <h5>Problem Info</h5>
                <p><strong>Difficulty:</strong> {{ problem.get_difficulty_display }}</p>
                <p><strong>Created by:</strong> {{ problem.created_by.email }}</p>
                <p><strong>Time limit:</strong> {{ problem.time_limit }}s</p>
                <p><strong>Memory limit:</strong> 256 MB</p>
            </div>

            <div class="sidebar-card mt-4">
                <h5>Submit Solution</h5>
                <form method="POST" enctype="multipart/form-data" action="{% url 'submit_solution' problem.pk %}">
                    {% csrf_token %}
                    {{ submission_form.non_field_errors }}

                    <div class="mb-2">
                        {{ submission_form.language.label_tag }}
                        {{ submission_form.language }}
                        {% if submission_form.language.errors %}
                            <div class="text-danger small">
                                {{ submission_form.language.errors }}
                            </div>
                        {% endif %}
                    </div>

                    <div class="mb-2">
                       {{ submission_form.code_file.label_tag }}
                        {{ submission_form.code_file }}
                        {% if submission_form.code_file.errors %}
                            <div class="text-danger small">
                                {{ submission_form.code_file.errors }}
                            </div>
                        {% endif %}
                    </div>

                    <input type="hidden" name="problem" value="{{ problem.id }}">

                    <button type="submit" class="btn btn-success w-100 mt-2">Submit</button>
                </form>
            </div>
        </aside>
    </div>
    {% endblock %}

    <!-- JS dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'ckeditor/ckeditor/ckeditor.js' %}"></script>
    <script src="{% static 'ckeditor/ckeditor-init.js' %}"></script>

    <!-- copy button, needs to be inline -->
    <script>
        document.querySelectorAll(".copy-btn").forEach(btn =>
            btn.addEventListener("click", () => {
                const code = btn.closest(".example-block")?.querySelector("pre code");
                if (!code) return;
                navigator.clipboard.writeText(code.textContent)
                    .then(() => {
                        const orig = btn.innerText;
                        btn.innerText = "Copied!";
                        setTimeout(() => btn.innerText = orig, 1000);
                    })
                    .catch(err => console.error(err));
            })
        );
    </script>

</body>
</html>
