{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/forms.css' %}">
<title>{% if form.instance.pk %}Edit{% else %}Add{% endif %} Problem</title>

</head>
<body>
{% include "nav.html" %}

<div class="form-container">
    <h2>{% if form.instance.pk %}Edit{% else %}Add New{% endif %} Problem</h2>

    <form method="POST">
        {% csrf_token %}
        {{ form.as_p }}

        <h4>Examples</h4>
        <div id="example-forms">
            {{ formset.management_form }}
            {% for f in formset %}
            <div class="example-form">
                <button class="btn btn-sm btn-danger remove-example" type="button">Remove</button>
                {{ f.id }}
                <div class="mb-2">{{ f.input.label_tag }} {{ f.input }}</div>
                <div class="mb-2">{{ f.output.label_tag }} {{ f.output }}</div>
                <div class="mb-2">{{ f.note.label_tag }} {{ f.note }}</div>
                {{ f.DELETE }}
            </div>
            {% endfor %}
        </div>
        <button class="btn btn-secondary mb-3" id="add-example" type="button">Add Example</button>

        <br>
        <button class="btn btn-success" type="submit">Save Problem</button>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


<!--Needs to be inline to work-->
<script>
$(document).ready(function(){
    let formIdx = {{ formset.total_form_count }};

    // Add new example
    $('#add-example').click(function(){
        // Clone first example-form, or create a blank if none exist
        let emptyForm = $('#example-forms div.example-form:first').length
                        ? $('#example-forms div.example-form:first').clone(true)
                        : $('<div class="example-form">' +
                            '<div class="mb-2"><label>Input:</label><textarea name="form-0-input"></textarea></div>' +
                            '<div class="mb-2"><label>Output:</label><textarea name="form-0-output"></textarea></div>' +
                            '<div class="mb-2"><label>Note:</label><textarea name="form-0-note"></textarea></div>' +
                          '</div>');

        // Reset values
        emptyForm.find('input, textarea').val('');
        emptyForm.find('input[type=hidden]').remove(); // remove id fields
        emptyForm.find('input[name$="-DELETE"]').prop('checked', false);

        // Update form index in names and ids
        emptyForm.find(':input').each(function(){
            let name = $(this).attr('name').replace(/-\d+-/, `-${formIdx}-`);
            let id = 'id_' + name;
            $(this).attr({'name': name, 'id': id});
        });

        // Add remove button if missing
        if (emptyForm.find('.remove-example').length === 0) {
            emptyForm.prepend('<button class="btn btn-sm btn-danger remove-example" type="button">Remove</button>');
        }

        // Ensure it's visible
        emptyForm.show();

        formIdx++;
        $('#example-forms').append(emptyForm);
        $('#id_form-TOTAL_FORMS').val(formIdx);
    });

    // Remove example using event delegation
    $('#example-forms').on('click', '.remove-example', function(){
        let container = $(this).closest('.example-form');
        container.find('input[name$="-DELETE"]').prop('checked', true);
        container.hide();
    });
});


</script>

</body>
</html>
