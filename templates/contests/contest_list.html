{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<title>Contests</title>
</head>
<body>
{% include "nav.html" %}

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Contests</h3>
    {% if user.is_staff %}
      <a href="{% url 'contest_create' %}" class="btn btn-primary">Create Contest</a>
    {% endif %}
  </div>

  <!-- Contest Cards -->
  <div class="row">
    {% for contest in contests %}
    <div class="col-md-4 mb-3">
      <div class="card h-100 shadow-sm border-1">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="card-title mb-0">{{ contest.name }}</h5>
            <span id="status-{{ contest.id }}" class="status-badge"></span>
          </div>

          <p class="card-text text-muted small mb-2">By {{ contest.creator.username }}</p>
          <p class="card-text">{{ contest.description|truncatechars:100 }}</p>
          <p class="card-text mb-1">
            <small><strong>Start:</strong> {{ contest.start_time|date:"Y-m-d H:i:s" }}</small>
          </p>
          <p class="card-text mb-1">
            <small><strong>End:</strong> {{ contest.end_time|date:"Y-m-d H:i:s" }}</small>
          </p>
          <p class="card-text mb-1">
            <small><strong>Countdown:</strong>
              <span id="countdown-{{ contest.id }}"
                data-start="{{ contest.start_time|date:'Y-m-d H:i:s' }}"
                data-end="{{ contest.end_time|date:'Y-m-d H:i:s' }}"></span>
            </small>
          </p>

          <a href="{% url 'contest_detail' contest.id %}" class="btn btn-outline-primary btn-sm mt-2">View Contest</a>

          {% if user.is_staff %}
            <a href="{% url 'contest_update' contest.pk %}" class="btn btn-outline-warning btn-sm">Edit</a>
            <form action="{% url 'contest_delete' contest.pk %}" method="post" class="d-inline">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Are you sure?')">Delete</button>
            </form>
          {% endif %}
        </div>
      </div>
    </div>
    {% empty %}
    <p class="text-center">No contests found.</p>
    {% endfor %}
  </div>
</div>

<!-- Countdown Script -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const countdownEls = document.querySelectorAll("[id^='countdown-']");

  function formatRemaining(ms) {
    if (ms <= 0) return "0s";
    const totalSeconds = Math.floor(ms / 1000);
    const days = Math.floor(totalSeconds / 86400);
    const hours = Math.floor((totalSeconds % 86400) / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    if (days > 0) return `${days}d ${hours}h ${minutes}m ${seconds}s`;
    if (hours > 0) return `${hours}h ${minutes}m ${seconds}s`;
    if (minutes > 0) return `${minutes}m ${seconds}s`;
    return `${seconds}s`;
  }

  function updateCountdown() {
    const now = new Date().getTime();

    countdownEls.forEach(el => {
      const start = new Date(el.dataset.start).getTime();
      const end = new Date(el.dataset.end).getTime();
      const statusEl = document.querySelector("#status-" + el.id.split("-")[1]);

      if (now < start) {
        el.textContent = "Starts in: " + formatRemaining(start - now);
        statusEl.textContent = "Upcoming";
        statusEl.style.backgroundColor = "#0d6efd"; // Blue
      } else if (now >= start && now <= end) {
        el.textContent = "Ends in: " + formatRemaining(end - now);
        statusEl.textContent = "Running";
        statusEl.style.backgroundColor = "#198754"; // Green
      } else {
        el.textContent = "Finished";
        statusEl.textContent = "Finished";
        statusEl.style.backgroundColor = "#6c757d"; // Gray
      }

      statusEl.style.color = "white";
      statusEl.style.padding = "0.25rem 0.5rem";
      statusEl.style.borderRadius = "0.25rem";
      statusEl.style.fontSize = "0.8rem";
    });
  }

  updateCountdown(); // initial call
  setInterval(updateCountdown, 1000);
});
</script>

</body>
</html>
